{% extends 'base.html' %}
{% block title %}Register â€” Insurance Predictor{% endblock %}

{% block content %}
    <div class="card reg-card shadow-sm">
      <div class="card-body p-4">
        <h4 class="mb-2">Create an account</h4>
        <p class="text-muted small">Register to save predictions and manage your profile.</p>

        <form id="regForm" novalidate>
          <div class="mb-3">
            <label class="form-label">Full name</label>
            <input type="text" class="form-control" name="name" required placeholder="Jane Doe" />
          </div>

          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" name="email" required placeholder="you@example.com" />
          </div>

          <div class="row g-2">
            <div class="col-md-6 mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" name="password" required minlength="6" />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Confirm password</label>
              <input type="password" class="form-control" name="confirm_password" required minlength="6" />
            </div>
          </div>

          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="terms" name="terms" required />
            <label class="form-check-label" for="terms">I agree to the terms</label>
          </div>

          <div class="d-grid gap-2">
            <button class="btn btn-primary" id="registerBtn" type="submit">Register</button>
          </div>
        </form>

        <div id="feedback" class="mt-3 d-none"></div>

        <div class="mt-3 small text-center text-muted">
          Already have an account? <a href="/login">Sign in</a>
        </div>
      </div>
    </div>

    <script>
      const form = document.getElementById('regForm');
      const feedback = document.getElementById('feedback');

      function showFeedback(msg, type='info'){
        feedback.className = 'alert alert-' + type;
        feedback.textContent = msg;
        feedback.classList.remove('d-none');
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const fd = new FormData(form);
        const payload = {
          name: fd.get('name'),
          email: fd.get('email'),
          password: fd.get('password'),
          confirm_password: fd.get('confirm_password')
        };

        if(payload.password !== payload.confirm_password){
          showFeedback('Passwords do not match', 'danger');
          return;
        }

        try{
          const resp = await fetch('/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: payload.email, password: payload.password })
          });

          const j = await resp.json();
          if(!resp.ok){
            throw new Error(j.message || 'Registration failed');
          }

          showFeedback(j.message || 'Registered successfully', 'success');
          if(j.redirect) window.location.href = j.redirect;
        }catch(err){
          showFeedback('Registration failed: ' + err.message, 'danger');
        }
      });
    </script>
{% endblock %}
